name: formigas_codemagic brick CI

on:
  pull_request:
    paths:
      - formigas_codemagic/**
      - .github/workflows/continuous-integration-formigas_codemagic.yaml
      - .github/workflows/check-codemagic-ci-label.yaml

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  create-pr-with-changes:
    name: Create PR with changes in test repository
    runs-on: ubuntu-latest

    env:
      branch_name: "codemagic-ci-changes-${{ github.event.pull_request.number }}"

    steps:
      - name: Checkout brick repository
        uses: actions/checkout@v4
        with:
          path: formigas-flutter-bricks

      - name: Create GitHub App token
        uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ vars.FORMIGAS_VERSION_BUMPER_APP_ID }}
          private-key: ${{ secrets.FORMIGAS_VERSION_BUMPER_PRIVATE_KEY }}
          owner: formigas
          repositories: codemagic-ci-brick-ci

      - name: Checkout codemagic test repository
        uses: actions/checkout@v4
        with:
          repository: formigas/codemagic-ci-brick-ci
          token: ${{ steps.app-token.outputs.token }}
          path: codemagic-ci-brick-ci

      - name: Install Dart SDK
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      - name: Install Mason CLI
        run: dart pub global activate mason_cli

      - name: Initialize Mason
        run: mason init

      - name: Add formigas_codemagic with Mason
        run: mason add formigas_codemagic --path ./formigas-flutter-bricks/formigas_codemagic

      - name: Make formigas_codemagic
        run: mason make formigas_codemagic
        working-directory: codemagic-ci-brick-ci

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v7
        with:
          branch: ${{ env.branch_name }}
          delete-branch: true
          commit-message: "Update codemagic CI workflow for codemagic CI brick PR ${{ github.event.pull_request.number }}"
          title: "Automated PR for Codemagic CI brick changes"
          body: "This PR is automatically generated by the Codemagic CI brick CI workflow. It will merge the changes made in the CI workflow into the main branch. Once the pipelines succeed, this PR will be automatically merged. See the [Codemagic CI brick PR](${{ github.event.pull_request.html_url }}) for more details."
          base: main
          path: codemagic-ci-brick-ci
          labels: automated-pr
          draft: false
          token: ${{ steps.app-token.outputs.token }}

      - name: Set auto-merge for Pull Request
        if: steps.create-pr.outputs.pull-request-operation == 'created'
        run: gh pr merge ${{ env.branch_name }} --auto
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        working-directory: codemagic-ci-brick-ci
