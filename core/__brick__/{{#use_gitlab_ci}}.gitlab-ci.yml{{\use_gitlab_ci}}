variables:
  FLUTTER_VERSION: "3.13.9"
  FLUTTER_DOCKER_IMAGE: "ghcr.io/cirruslabs/flutter:${FLUTTER_VERSION}"
  UBUNTU_DOCKER_IMAGE: "ubuntu:22.04"

stages:
  - validate
  - build
  - test

validate:
  stage: validate
  image: $FLUTTER_DOCKER_IMAGE
  script:
    - cd {{project_name.snakeCase()}}
    - dart format -o none --set-exit-if-changed lib/ test/
    - dart run build_runner build --delete-conflicting-outputs
    - flutter analyze --fatal-infos --fatal-warnings
  rules:
    - if: $CI_COMMIT_BRANCH == "develop" || $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "staging"
    - if: $CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "main"

.build_android:
  stage: build
  image: $FLUTTER_DOCKER_IMAGE
  needs: []
  script:
    - cd {{project_name.snakeCase()}}
    - flutter clean
    - dart run build_runner build --delete-conflicting-outputs
    - flutter build appbundle --debug --flavor $FLAVOR -t lib/main_$FLAVOR.dart

build_development:
  extends: .build_android
  variables:
    FLAVOR: "development"
  rules:
    - if: $CI_COMMIT_BRANCH == "develop" || $CI_PIPELINE_SOURCE == "merge_request_event"

build_staging:
  extends: .build_android
  variables:
    FLAVOR: "staging"
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"

build_production:
  extends: .build_android
  variables:
    FLAVOR: "production"
  rules:
    - if: $CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "main"

# Build iOS app not supported by GitLab CI yet

test:
  stage: test
  needs: []
  image: $FLUTTER_DOCKER_IMAGE
  script:
    - flutter pub global activate junitreport
    - set -o pipefail
    - cd {{project_name.snakeCase()}}
    - flutter clean
    - dart run build_runner build --delete-conflicting-outputs
    - flutter test --machine --coverage | tee >( $HOME/.pub-cache/bin/tojunit > test-report-app.xml )
    - flutter pub global activate cobertura
    - $HOME/.pub-cache/bin/cobertura convert -i coverage/lcov.info -o coverage/cobertura.xml -p pubspec.yaml
    - apt update && apt install -y lcov
    - genhtml -o docs/coverage/ --no-function-coverage --no-branch-coverage coverage/lcov.info
    - lcov --list coverage/lcov.info
  coverage: '/lines\.*: \d+\.\d+\%/'
  artifacts:
    reports:
      junit: {{project_name.snakeCase()}}/test-report-app.xml
      coverage_report:
          coverage_format: cobertura
          path: {{project_name.snakeCase()}}/coverage/cobertura.xml
    paths:
    - {{project_name.snakeCase()}}/coverage/lcov.info
    - {{project_name.snakeCase()}}/coverage/cobertura.xml
    - {{project_name.snakeCase()}}/docs/coverage/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == "develop" || $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "staging"
    - if: $CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "main"
